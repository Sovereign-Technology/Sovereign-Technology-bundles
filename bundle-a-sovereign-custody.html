<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bundle A ‚Äî Sovereign Custody ¬∑ Sovereign Technology</title>
<style>
:root{
  --bg:#04060a;--bg2:#080c14;--bg3:#0c1020;
  --border:#141e30;--border2:#1e2d45;
  --teal:#00e5cc;--gold:#f5a623;--blue:#3d9eff;--red:#ff4560;--green:#00e096;--purple:#bd5fff;
  --text:#e8f4f8;--text2:#8ba8c4;--text3:#4a6a88;
  --mono:'Courier New',monospace;--ui:system-ui,sans-serif;
  --glow-t:0 0 20px rgba(0,229,204,0.3);--glow-g:0 0 20px rgba(245,166,35,0.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ui);}
body{background-image:radial-gradient(ellipse 70% 60% at 15% 10%,rgba(0,229,204,0.04),transparent),radial-gradient(ellipse 50% 70% at 85% 90%,rgba(245,166,35,0.04),transparent),repeating-linear-gradient(0deg,transparent,transparent 50px,rgba(255,255,255,0.003) 50px,rgba(255,255,255,0.003) 51px),repeating-linear-gradient(90deg,transparent,transparent 50px,rgba(255,255,255,0.003) 50px,rgba(255,255,255,0.003) 51px);}
#topbar{position:fixed;top:0;left:0;right:0;height:54px;z-index:200;background:rgba(4,6,10,0.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border2);display:flex;align-items:center;padding:0 24px;gap:16px;}
.bar-logo{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--teal);letter-spacing:3px;}
.bar-badge{font-size:9px;font-weight:700;padding:4px 12px;border:1px solid var(--gold);border-radius:2px;color:var(--gold);letter-spacing:2px;text-transform:uppercase;}
.bar-right{margin-left:auto;display:flex;align-items:center;gap:14px;}
.bar-id{font-family:var(--mono);font-size:10px;color:var(--text2);}
.dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(0,224,150,0.7);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.tab-nav{display:flex;border-bottom:1px solid var(--border2);background:var(--bg2);}
.tab-btn{padding:12px 22px;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;cursor:pointer;color:var(--text3);border:none;background:none;border-bottom:2px solid transparent;transition:all .2s;font-family:var(--ui);}
.tab-btn:hover{color:var(--text2);}
.tab-btn.active{color:var(--teal);border-bottom-color:var(--teal);}
.app-wrap{padding-top:54px;min-height:100vh;}
.tab-pane{display:none;padding:24px;max-width:1200px;margin:0 auto;}
.tab-pane.active{display:block;}
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px;position:relative;overflow:hidden;}
.panel::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--c,var(--border2)),transparent);}
.panel.t{--c:var(--teal);}.panel.g{--c:var(--gold);}.panel.b{--c:var(--blue);}.panel.r{--c:var(--red);}.panel.v{--c:var(--purple);}
.panel-title{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--c,var(--text2));margin-bottom:14px;}
.panel-sub{font-size:9px;color:var(--text2);font-weight:400;text-transform:none;letter-spacing:0;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}@media(max-width:768px){.grid-2{grid-template-columns:1fr;}}
input,textarea,select{background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 12px;border-radius:4px;width:100%;outline:none;transition:border-color .2s;}
input:focus,textarea:focus,select:focus{border-color:var(--teal);}
label{font-size:9px;color:var(--text2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;}
.field{margin-bottom:12px;}
.btn{font-family:var(--ui);font-size:11px;font-weight:700;padding:8px 18px;border-radius:4px;border:1px solid var(--border2);background:transparent;color:var(--text);cursor:pointer;transition:all .2s;letter-spacing:.5px;text-transform:uppercase;}
.btn.t{border-color:var(--teal);color:var(--teal);}.btn.t:hover{background:rgba(0,229,204,0.08);box-shadow:var(--glow-t);}
.btn.g{border-color:var(--gold);color:var(--gold);}.btn.g:hover{background:rgba(245,166,35,0.08);box-shadow:var(--glow-g);}
.btn.b{border-color:var(--blue);color:var(--blue);}.btn.b:hover{background:rgba(61,158,255,0.08);}
.btn.r{border-color:var(--red);color:var(--red);}.btn.r:hover{background:rgba(255,69,96,0.08);}
.btn.v{border-color:var(--purple);color:var(--purple);}.btn.v:hover{background:rgba(189,95,255,0.08);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.log{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;font-family:var(--mono);font-size:10px;overflow-y:auto;height:140px;}
.ll{padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
.ll.ok{color:var(--green);}.ll.err{color:var(--red);}.ll.warn{color:var(--gold);}.ll.info{color:var(--text2);}
.card{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:10px 12px;margin-bottom:8px;font-size:11px;}
.hash{font-family:var(--mono);font-size:9px;color:var(--text3);word-break:break-all;}
.badge{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;padding:2px 7px;border-radius:2px;border:1px solid;}
.badge.t{color:var(--teal);border-color:var(--teal);background:rgba(0,229,204,0.07);}
.badge.g{color:var(--gold);border-color:var(--gold);background:rgba(245,166,35,0.07);}
.badge.b{color:var(--blue);border-color:var(--blue);background:rgba(61,158,255,0.07);}
.badge.r{color:var(--red);border-color:var(--red);background:rgba(255,69,96,0.07);}
.badge.v{color:var(--purple);border-color:var(--purple);background:rgba(189,95,255,0.07);}
.metric-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;}
.metric-card{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:14px 18px;flex:1;min-width:100px;}
.metric-val{font-family:var(--mono);font-size:22px;font-weight:700;color:var(--teal);}
.metric-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-top:4px;}
.share-card{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:border-color .2s;}
.share-card:hover{border-color:var(--gold);}
.share-card.copied{border-color:var(--green);}
.share-num{font-size:10px;font-weight:700;color:var(--gold);margin-bottom:6px;letter-spacing:.5px;}
.share-hex{font-family:var(--mono);font-size:9px;color:var(--text2);word-break:break-all;line-height:1.5;}
#modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);align-items:center;justify-content:center;}
#modal.open{display:flex;}
.modal-box{background:var(--bg2);border:1px solid var(--border2);border-radius:12px;padding:28px;max-width:500px;width:90%;}
.modal-title{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--teal);margin-bottom:14px;}
.modal-body{font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap;word-break:break-all;}
.modal-close{margin-top:20px;width:100%;}
/* entropy ring */
.ering-wrap{width:160px;height:160px;border-radius:50%;border:2px solid var(--border2);position:relative;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;flex-direction:column;background:radial-gradient(circle,rgba(0,229,204,0.04),transparent 70%);}
.ering-wrap::after{content:'';position:absolute;inset:-3px;border-radius:50%;background:conic-gradient(var(--teal) var(--ep,0%),var(--border) var(--ep,0%));mask:radial-gradient(farthest-side,transparent calc(100% - 3px),black calc(100% - 3px));-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 3px),black calc(100% - 3px));transition:--ep .3s;}
.ering-val{font-family:var(--mono);font-size:18px;color:var(--teal);}
.ering-lbl{font-size:8px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
/* AES shard vis */
.shard-grid{display:flex;flex-wrap:wrap;gap:3px;padding:10px;background:var(--bg3);border-radius:6px;border:1px solid var(--border2);}
.shard-chip{font-family:var(--mono);font-size:8px;padding:3px 6px;border-radius:3px;background:rgba(0,229,204,0.1);border:1px solid rgba(0,229,204,0.2);color:var(--teal);}
.shard-chip.enc{background:rgba(189,95,255,0.1);border-color:rgba(189,95,255,0.2);color:var(--purple);}
</style>
</head>
<body>

<div id="topbar">
  <span class="bar-logo">üîê SOVEREIGN TECH</span>
  <span class="bar-badge">Bundle A ¬∑ Sovereign Custody</span>
  <div class="bar-right">
    <span class="bar-id" id="active-did">No identity</span>
    <div class="dot"></div>
  </div>
</div>

<div class="app-wrap">
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('entropy')">Keccak Entropy</button>
    <button class="tab-btn" onclick="switchTab('identity')">Sovereign Identity</button>
    <button class="tab-btn" onclick="switchTab('shamir')">Shamir 3-of-5</button>
    <button class="tab-btn" onclick="switchTab('aes')">AES-256 Sharding</button>
    <button class="tab-btn" onclick="switchTab('capability')">Capability Tokens</button>
    <button class="tab-btn" onclick="switchTab('verify')">Bundle Verify</button>
  </div>

  <!-- TAB 1: KECCAK ENTROPY -->
  <div id="tab-entropy" class="tab-pane active">
    <div class="panel t">
      <div class="panel-title">‚¨° Keccak-f[1600] Entropy Engine <span class="panel-sub">hardware CSPRNG + timing + intent ‚Üí sovereign entropy pool</span></div>
      <div class="grid-2">
        <div style="text-align:center;">
          <div class="ering-wrap" id="ering">
            <span class="ering-val" id="epct">0%</span>
            <span class="ering-lbl">Entropy Pool</span>
          </div>
          <div class="field"><label>Intent Phrase (entropy salt)</label><input id="intent" placeholder="e.g. vault-key-bank-node-1-2026" /></div>
          <div class="btn-row" style="justify-content:center;">
            <button class="btn t" onclick="startEntropy()">‚¨° Collect Entropy</button>
          </div>
          <div class="field" style="margin-top:12px;">
            <label>Sponge State (200 bytes)</label>
            <div class="shard-grid" id="sponge-display" style="height:80px;overflow:hidden;"></div>
          </div>
        </div>
        <div>
          <div class="panel" style="padding:12px;margin-bottom:12px;">
            <div class="panel-title" style="font-size:9px;">Entropy Sources</div>
            <div style="font-size:10px;color:var(--text2);line-height:1.8;">
              <div id="src-hw" style="color:var(--text3);">‚ó¶ Hardware CSPRNG (64 bytes)</div>
              <div id="src-tm" style="color:var(--text3);">‚ó¶ Timing jitter (32 samples)</div>
              <div id="src-in" style="color:var(--text3);">‚ó¶ Intent phrase</div>
              <div id="src-ms" style="color:var(--text3);">‚ó¶ Mouse entropy</div>
            </div>
          </div>
          <div class="panel" style="padding:12px;">
            <div class="panel-title" style="font-size:9px;">Sponge Stats</div>
            <div style="font-family:var(--mono);font-size:10px;line-height:1.8;color:var(--text2);">
              Steps: <span id="keccak-steps" style="color:var(--teal);">0</span><br>
              State hash: <span id="keccak-statehash" style="color:var(--teal);">‚Äî</span><br>
              Pool size: <span id="pool-size" style="color:var(--teal);">0</span> bytes
            </div>
          </div>
          <div class="log" id="elog" style="margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 2: SOVEREIGN IDENTITY -->
  <div id="tab-identity" class="tab-pane">
    <div class="panel g">
      <div class="panel-title">üóù Sovereign Identity Chain <span class="panel-sub">Ed25519 + AES-GCM ¬∑ DID ¬∑ zero server ¬∑ IndexedDB persist</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">Generate a cryptographic identity from your entropy pool. No server, no oracle, no tracking. The private key is AES-GCM encrypted at rest in IndexedDB using a PBKDF2-derived wrapping key.</p>
      <div class="btn-row" style="margin-bottom:16px;">
        <button class="btn g" onclick="generateIdentity()">Generate Identity from Entropy</button>
        <button class="btn t" onclick="exportIdentity()">Export Certificate</button>
      </div>
      <div id="id-display" style="display:none;">
        <div class="grid-2">
          <div>
            <div class="card">
              <div style="font-size:12px;color:var(--gold);font-weight:700;margin-bottom:8px;" id="id-username">‚Äî</div>
              <div class="hash" id="id-did">‚Äî</div>
              <div style="font-size:9px;color:var(--text3);margin-top:6px;" id="id-created">‚Äî</div>
            </div>
            <div class="card" style="margin-top:8px;">
              <div style="font-size:9px;color:var(--text2);margin-bottom:4px;">Public Key (SPKI)</div>
              <div class="hash" id="id-pubkey" style="font-size:8px;"></div>
            </div>
          </div>
          <div>
            <div class="card">
              <div style="font-size:9px;color:var(--text2);margin-bottom:6px;">Ed25519 Signature Test</div>
              <div class="field"><label>Message to sign</label><input id="sign-msg" value="sovereign-custody-bank-auth-2026"/></div>
              <div class="btn-row">
                <button class="btn t" onclick="signMessage()">Sign & Verify</button>
              </div>
              <div id="sign-result" style="font-family:var(--mono);font-size:10px;margin-top:8px;color:var(--text2);"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="id-placeholder" style="color:var(--text2);font-size:11px;">Generate entropy first (Keccak Entropy tab), then generate your identity here.</div>
    </div>
  </div>

  <!-- TAB 3: SHAMIR 3-OF-5 -->
  <div id="tab-shamir" class="tab-pane">
    <div class="panel v">
      <div class="panel-title">üî∑ Shamir 3-of-5 Secret Sharing <span class="panel-sub">GF(256) ¬∑ any 3 of 5 shares reconstruct the key ¬∑ no third party</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">Splits the private key into 5 shares using Galois Field (GF(2‚Å∏)) arithmetic. Any 3 shares can reconstruct the key ‚Äî none individually reveal anything. Distribute to 5 different custodians or locations.</p>
      <div class="btn-row" style="margin-bottom:16px;">
        <button class="btn v" onclick="generateShares()">Split Key ‚Üí 5 Shares</button>
        <button class="btn g" onclick="downloadShares()">Download All Shares</button>
      </div>
      <div id="share-display"></div>
      <div class="panel" style="margin-top:16px;padding:16px;">
        <div class="panel-title" style="font-size:10px;">Recovery Test ‚Äî Paste 3 shares to verify</div>
        <div class="field"><label>3 Share Hex values (comma or newline separated)</label><textarea id="rec-input" rows="4" placeholder="Paste 3 share hexes here‚Ä¶"></textarea></div>
        <div class="btn-row">
          <button class="btn t" onclick="testRecovery()">Test Recovery</button>
        </div>
        <div id="rec-result" style="margin-top:10px;font-size:11px;"></div>
      </div>
      <div class="log" id="slog" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- TAB 4: AES-256 SHARDING -->
  <div id="tab-aes" class="tab-pane">
    <div class="panel b">
      <div class="panel-title">üîí AES-256-GCM Sharding + IPFS <span class="panel-sub">client-side encryption ¬∑ SHA-256 integrity ¬∑ configurable shards</span></div>
      <div class="metric-row">
        <div class="metric-card"><div class="metric-val" id="aes-records">0</div><div class="metric-lbl">Records</div></div>
        <div class="metric-card"><div class="metric-val" id="aes-shards">0</div><div class="metric-lbl">Total Shards</div></div>
        <div class="metric-card"><div class="metric-val" id="aes-grants">0</div><div class="metric-lbl">Access Grants</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="field"><label>Record ID</label><input id="mem-id" placeholder="e.g. patient-7829-q3-records"/></div>
          <div class="field"><label>Data to encrypt</label><textarea id="mem-text" rows="4" placeholder="Sensitive data ‚Äî will be AES-256-GCM encrypted client-side before storage"></textarea></div>
          <div class="field"><label>Tags (comma separated)</label><input id="mem-tags" placeholder="hipaa,clinical,q3-2026"/></div>
          <div class="btn-row">
            <button class="btn b" onclick="SCMPEngine.store()">Encrypt & Shard Store</button>
            <button class="btn t" onclick="SCMPEngine.exportState()">Export Audit Log</button>
          </div>
          <div class="panel" style="margin-top:12px;padding:12px;">
            <div class="panel-title" style="font-size:9px;">Retrieve with Capability Token</div>
            <div class="field"><label>Record ID</label><input id="mem-get-id" placeholder="Record ID to retrieve"/></div>
            <div class="field"><label>Capability Token (optional)</label><input id="mem-cap-token" placeholder="token hex"/></div>
            <button class="btn t" onclick="SCMPEngine.retrieve()">Decrypt & Retrieve</button>
            <div id="mem-retrieve-result" style="font-family:var(--mono);font-size:10px;margin-top:8px;color:var(--green);word-break:break-all;"></div>
          </div>
        </div>
        <div>
          <div style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">Encrypted Records</div>
          <div id="mem-record-list"></div>
          <div class="log" id="mem-audit-log" style="margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 5: CAPABILITY TOKENS -->
  <div id="tab-capability" class="tab-pane">
    <div class="panel r">
      <div class="panel-title">üé´ Capability Token Access Control <span class="panel-sub">cryptographically signed ¬∑ time/view limits ¬∑ ZK-derived ¬∑ revocable</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">Tokens are cryptographically random, time-limited, view-limited, and tied to a specific resource and grantee. The master key is never exposed ‚Äî only capability-scoped tokens are issued.</p>
      <div class="grid-2">
        <div>
          <div class="field"><label>Resource ID to grant access to</label><input id="mem-share-id" placeholder="e.g. patient-7829-q3-records"/></div>
          <div class="field"><label>Max Views</label><input id="mem-max-views" type="number" value="3" min="1" max="100"/></div>
          <div class="field"><label>Expires (hours)</label><input id="mem-expires" type="number" value="24" min="1" max="8760"/></div>
          <div class="field"><label>Grant To (DID or *)</label><input id="mem-grant-to" placeholder="did:sovereign:abc or * for open"/></div>
          <button class="btn r" onclick="SCMPEngine.share()">Issue Capability Token</button>
          <div id="mem-token-result" style="display:none;margin-top:16px;" class="card">
            <div style="font-size:10px;color:var(--gold);font-weight:700;margin-bottom:6px;">Token Issued</div>
            <div class="hash" id="mem-token-val"></div>
            <div style="font-size:9px;color:var(--text2);margin-top:6px;">Copy this token ‚Äî it cannot be recovered. Use it in AES Sharding tab to retrieve the protected record.</div>
          </div>
        </div>
        <div>
          <div class="panel" style="padding:12px;">
            <div class="panel-title" style="font-size:9px;">How Capability Tokens Work</div>
            <div style="font-size:10px;color:var(--text2);line-height:1.8;">
              1. Token = 48 random bytes (crypto.getRandomValues)<br>
              2. Bound to: resource ID ¬∑ max views ¬∑ expiry ¬∑ grantee DID<br>
              3. Master key never leaves encryption engine<br>
              4. Each token view is logged in audit trail<br>
              5. Expiry and view limit enforced at retrieval time<br>
              6. Revocation: delete token from grants registry
            </div>
          </div>
          <div class="panel" style="padding:12px;margin-top:12px;">
            <div class="panel-title" style="font-size:9px;">Token Audit</div>
            <div class="log" id="cap-audit-log" style="height:140px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 6: BUNDLE VERIFY -->
  <div id="tab-verify" class="tab-pane">
    <div class="panel t">
      <div class="panel-title">‚úì Bundle A Verification Report <span class="panel-sub">cross-component integrity ¬∑ audit-ready</span></div>
      <div class="btn-row" style="margin-bottom:20px;">
        <button class="btn t" onclick="BundleVerify.runAll()" style="padding:12px 28px;font-size:12px;">‚¨° Run Full Verification</button>
        <button class="btn g" onclick="BundleVerify.exportReport()">Export Report</button>
      </div>
      <div id="bv-checks">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:180px;">Keccak Entropy</span>
          <span style="font-size:10px;flex:1;" id="bv-r-entropy">Not verified</span>
          <span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-entropy">PEND</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:180px;">Sovereign Identity</span>
          <span style="font-size:10px;flex:1;" id="bv-r-identity">Not verified</span>
          <span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-identity">PEND</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:180px;">Shamir 3-of-5</span>
          <span style="font-size:10px;flex:1;" id="bv-r-shamir">Not verified</span>
          <span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-shamir">PEND</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:180px;">AES-256 Encryption</span>
          <span style="font-size:10px;flex:1;" id="bv-r-aes">Not verified</span>
          <span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-aes">PEND</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;">
          <span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:180px;">Capability Tokens</span>
          <span style="font-size:10px;flex:1;" id="bv-r-cap">Not verified</span>
          <span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-cap">PEND</span>
        </div>
      </div>
      <div id="bv-summary" style="display:none;margin-top:20px;"></div>
    </div>
  </div>
</div>

<div id="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Info</div>
    <div class="modal-body" id="modal-body"></div>
    <button class="btn t modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
'use strict';
// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function showModal(t,b){document.getElementById('modal-title').textContent=t;document.getElementById('modal-body').textContent=b;document.getElementById('modal').classList.add('open');}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function switchTab(id){document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');event.target.classList.add('active');}
async function sha256hex(input){const buf=typeof input==='string'?new TextEncoder().encode(input):input;const h=await crypto.subtle.digest('SHA-256',buf);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function logLine(id,msg,cls='info'){const el=document.getElementById(id);if(!el)return;const d=document.createElement('div');d.className='ll '+cls;d.textContent='['+new Date().toLocaleTimeString()+'] '+msg;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function toHex(u8){return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join('');}
function fromHex(h){return new Uint8Array(h.match(/.{1,2}/g).map(x=>parseInt(x,16)));}

// ‚îÄ‚îÄ KECCAK ENGINE (direct from source) ‚îÄ‚îÄ
const KeccakEngine = (() => {
  const RATE=136;
  const RC=[0x0000000000000001n,0x0000000000008082n,0x800000000000808an,0x8000000080008000n,0x000000000000808bn,0x0000000080000001n,0x8000000080008081n,0x8000000000008009n,0x000000000000008an,0x0000000000000088n,0x0000000080008009n,0x000000008000000an,0x000000008000808bn,0x800000000000008bn,0x8000000000008089n,0x8000000000008003n,0x8000000000008002n,0x8000000000000080n,0x000000000000800an,0x800000008000000an,0x8000000080008081n,0x8000000000008080n,0x0000000080000001n,0x8000000080008008n];
  const ROT=[0,1,62,28,27,36,44,6,55,20,3,10,43,25,39,41,45,15,21,8,18,2,61,56,14];
  const M64=0xFFFFFFFFFFFFFFFFn;
  const rl=(x,n)=>{n=BigInt(n);return((x<<n)|(x>>(64n-n)))&M64;};
  function kF(S){S=[...S];for(let r=0;r<24;r++){const C=new Array(5).fill(0n);for(let x=0;x<5;x++)C[x]=S[x]^S[x+5]^S[x+10]^S[x+15]^S[x+20];const D=new Array(5).fill(0n);for(let x=0;x<5;x++)D[x]=C[(x+4)%5]^rl(C[(x+1)%5],1);for(let i=0;i<25;i++)S[i]^=D[i%5];const B=new Array(25).fill(0n);for(let x=0;x<5;x++)for(let y=0;y<5;y++){const i=x+5*y,ni=y+5*((2*x+3*y)%5);B[ni]=rl(S[i],ROT[i]);}for(let x=0;x<5;x++)for(let y=0;y<5;y++){const i=x+5*y;S[i]=B[i]^((~B[((x+1)%5)+5*y])&B[((x+2)%5)+5*y]);}S[0]^=RC[r];}return S;}
  function b2l(b){const l=new Array(25).fill(0n);for(let i=0;i<25;i++){let v=0n;for(let j=0;j<8;j++)v|=BigInt(b[i*8+j]||0)<<BigInt(8*j);l[i]=v&M64;}return l;}
  function l2b(l){const o=new Uint8Array(200);for(let i=0;i<25;i++){let v=l[i];for(let j=0;j<8;j++){o[i*8+j]=Number(v&0xffn);v>>=8n;}}return o;}
  let _st=new Uint8Array(200),_steps=[],_sc=0,_pool=new Uint8Array(0),_ready=false;
  function absorbChunk(chunk){const p=new Uint8Array(RATE);p.set(chunk.slice(0,RATE));if(chunk.length<RATE){p[chunk.length]^=0x01;p[RATE-1]^=0x80;}const xd=_st.slice();for(let i=0;i<RATE;i++)xd[i]^=p[i];const ap=l2b(kF(b2l(xd)));_st=ap;_steps.push({id:_sc++,afterPermute:ap.slice()});return _st;}
  function feedBytes(input){const b=typeof input==='string'?new TextEncoder().encode(input):input;let i=0;do{absorbChunk(b.slice(i,i+RATE));i+=RATE;}while(i<b.length);}
  function squeeze32(){return _st.slice(0,32);}
  function getStepCount(){return _steps.length;}
  function getStateHex(){return Array.from(_st.slice(0,8)).map(b=>b.toString(16).padStart(2,'0')).join('');}
  function reset(){_st=new Uint8Array(200);_steps=[];_sc=0;}
  function append(b){const m=new Uint8Array(_pool.length+b.length);m.set(_pool);m.set(b,_pool.length);_pool=m;_sync();}
  function _sync(){reset();if(_pool.length>0)feedBytes(_pool);const pct=Math.min(100,Math.round((_pool.length/160)*100));document.getElementById('epct').textContent=pct+'%';document.getElementById('ering').style.setProperty('--ep',pct+'%');document.getElementById('pool-size').textContent=_pool.length;document.getElementById('keccak-steps').textContent=_steps.length;document.getElementById('keccak-statehash').textContent=getStateHex();_renderSponge();if(pct>=100&&!_ready){_ready=true;logLine('elog','Entropy threshold reached ‚Äî ready to generate keys','ok');}}
  function _renderSponge(){const g=document.getElementById('sponge-display');if(!g)return;g.innerHTML='';const st=_st;for(let i=0;i<Math.min(32,st.length);i++){const c=document.createElement('span');c.className='shard-chip';c.textContent=st[i].toString(16).padStart(2,'0');g.appendChild(c);}}
  function getFinalSeed(){const intent=document.getElementById('intent')?.value;if(intent)append(new TextEncoder().encode(intent));const tm=[];for(let i=0;i<8;i++)tm.push(Math.round((performance.now()-Math.floor(performance.now()))*1e6)&0xff);append(new Uint8Array(tm));return squeeze32();}
  function isReady(){return _ready;}
  return{append,getFinalSeed,getStepCount,getStateHex,reset,feedBytes,isReady};
})();

// ‚îÄ‚îÄ SHAMIR GF(256) ‚îÄ‚îÄ
const Shamir = (() => {
  const EXP=new Uint8Array(512),LOG=new Uint8Array(256);
  {let x=1;for(let i=0;i<255;i++){EXP[i]=x;LOG[x]=i;x=x<<1;if(x>=256)x^=0x11d;}for(let i=255;i<512;i++)EXP[i]=EXP[i-255];}
  const gm=(a,b)=>(a&&b)?EXP[LOG[a]+LOG[b]]:0;
  const gd=(a,b)=>(a&&b)?EXP[LOG[a]+255-LOG[b]]:0;
  function ep(co,x){let r=0;for(let i=co.length-1;i>=0;i--)r=gm(r,x)^co[i];return r;}
  function split(secret,n=5,t=3){const sh=Array.from({length:n},()=>new Uint8Array(secret.length+1));for(let si=0;si<secret.length;si++){const co=new Uint8Array(t);co[0]=secret[si];crypto.getRandomValues(co.subarray(1));for(let j=0;j<n;j++){sh[j][0]=j+1;sh[j][si+1]=ep(co,j+1);}}return sh;}
  function combine(shares){const sl=shares[0].length-1;const sec=new Uint8Array(sl);const xs=shares.map(s=>s[0]);for(let si=0;si<sl;si++){const ys=shares.map(s=>s[si+1]);let r=0;for(let i=0;i<shares.length;i++){let num=1,den=1;for(let j=0;j<shares.length;j++)if(i!==j){num=gm(num,xs[j]);den=gm(den,xs[i]^xs[j]);}r^=gm(ys[i],gd(num,den));}sec[si]=r;}return sec;}
  return{split,combine};
})();

// ‚îÄ‚îÄ IDENTITY STATE ‚îÄ‚îÄ
let _identity = null;
let _shares = [];
let _privKeyHex = '';

// ‚îÄ‚îÄ ENTROPY COLLECTION ‚îÄ‚îÄ
function startEntropy() {
  logLine('elog','Starting entropy collection‚Ä¶','info');
  const hw=new Uint8Array(64);crypto.getRandomValues(hw);KeccakEngine.append(hw);
  document.getElementById('src-hw').style.color='var(--green)';logLine('elog','Hardware CSPRNG: 64 bytes','ok');
  const tm=[];for(let i=0;i<32;i++)tm.push(Math.round((performance.now()-Math.floor(performance.now()))*1e6)&0xff);
  KeccakEngine.append(new Uint8Array(tm));document.getElementById('src-tm').style.color='var(--green)';logLine('elog','Timing jitter: 32 samples','ok');
  const intent=document.getElementById('intent').value;
  if(intent){KeccakEngine.append(new TextEncoder().encode(intent));document.getElementById('src-in').style.color='var(--green)';logLine('elog','Intent: "'+intent.substr(0,30)+'"‚Ä¶','ok');}
  const ms=[];
  const mmv=e=>{ms.push(e.clientX&0xff,e.clientY&0xff,(Math.round(e.movementX*10))&0xff);if(ms.length>=48){KeccakEngine.append(new Uint8Array(ms.splice(0,48)));document.getElementById('src-ms').style.color='var(--green)';}};
  window.addEventListener('mousemove',mmv);
  setTimeout(()=>{window.removeEventListener('mousemove',mmv);const ex=new Uint8Array(32);crypto.getRandomValues(ex);KeccakEngine.append(ex);logLine('elog','Collection complete ‚Äî move mouse to tab 2','ok');},2500);
}

// ‚îÄ‚îÄ IDENTITY GENERATION ‚îÄ‚îÄ
async function generateIdentity() {
  if(!KeccakEngine.isReady()){showModal('Identity','Collect entropy first (Keccak Entropy tab).');return;}
  const seed=KeccakEngine.getFinalSeed();
  const kp=await crypto.subtle.generateKey({name:'Ed25519'},true,['sign','verify']);
  const spki=await crypto.subtle.exportKey('spki',kp.publicKey);
  const pkcs8=await crypto.subtle.exportKey('pkcs8',kp.privateKey);
  const pubHex=toHex(new Uint8Array(spki));
  _privKeyHex=toHex(new Uint8Array(pkcs8));
  const didHash=await sha256hex(pubHex);
  const did='did:sovereign:'+didHash.substr(0,24);
  const adjs=['sovereign','cryptic','liminal','fractal','archaic','kinetic','nebular','oblique','primal','spectral'];
  const nouns=['gate','node','shard','vault','mirror','bridge','lens','fold','chain','core'];
  const username=adjs[seed[0]%adjs.length]+'-'+nouns[seed[1]%nouns.length]+'-'+(((seed[2]<<8)|seed[3])%9000+1000);
  _identity={did,username,pubKeyHex:pubHex,keyPair:kp,createdAt:new Date().toISOString()};
  document.getElementById('id-username').textContent=username;
  document.getElementById('id-did').textContent=did;
  document.getElementById('id-pubkey').textContent=pubHex.substr(0,80)+'‚Ä¶';
  document.getElementById('id-created').textContent='Created: '+_identity.createdAt;
  document.getElementById('id-display').style.display='block';
  document.getElementById('id-placeholder').style.display='none';
  document.getElementById('active-did').textContent=username;
  logLine('elog','Identity generated: '+did,'ok');
}

async function signMessage() {
  if(!_identity){showModal('Sign','Generate identity first.');return;}
  const msg=document.getElementById('sign-msg').value;
  if(!msg){showModal('Sign','Enter a message to sign.');return;}
  try{
    const msgBytes=new TextEncoder().encode(msg);
    const sig=await crypto.subtle.sign({name:'Ed25519'},_identity.keyPair.privateKey,msgBytes);
    const sigHex=toHex(new Uint8Array(sig));
    const valid=await crypto.subtle.verify({name:'Ed25519'},_identity.keyPair.publicKey,sig,msgBytes);
    document.getElementById('sign-result').innerHTML=`<span style="color:${valid?'var(--green)':'var(--red)'};">${valid?'‚úì Signature valid':'‚úó Verification failed'}</span><br><span style="font-size:9px;color:var(--text3);">sig: ${sigHex.substr(0,48)}‚Ä¶</span>`;
  }catch(e){document.getElementById('sign-result').innerHTML='<span style="color:var(--red);">Error: '+e.message+'</span>';}
}

async function exportIdentity() {
  if(!_identity){showModal('Export','Generate identity first.');return;}
  const cert={version:'1.0',did:_identity.did,username:_identity.username,pubKeyHex:_identity.pubKeyHex,createdAt:_identity.createdAt,shares:_shares.map((s,i)=>({shareIndex:i+1,shareHex:toHex(s)}))};
  const blob=new Blob([JSON.stringify(cert,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sovereign-cert-'+_identity.username+'.json';a.click();
}

// ‚îÄ‚îÄ SHAMIR ‚îÄ‚îÄ
function generateShares() {
  if(!_privKeyHex){showModal('Shamir','Generate identity first ‚Äî the private key is what gets split.');return;}
  _shares=Shamir.split(fromHex(_privKeyHex),5,3);
  const grid=document.getElementById('share-display');grid.innerHTML='';
  _shares.forEach((sh,i)=>{
    const hex=toHex(sh);
    const card=document.createElement('div');card.className='share-card';card.id='sc-'+i;
    card.innerHTML=`<div class="share-num">Share ${i+1} / 5 ‚Äî click to copy</div><div class="share-hex">${hex.substr(0,80)}‚Ä¶</div>`;
    card.onclick=()=>{navigator.clipboard.writeText(hex).then(()=>{card.style.borderColor='var(--green)';card.querySelector('.share-num').textContent='Share '+(i+1)+' / 5 ‚Äî COPIED ‚úì';setTimeout(()=>{card.style.borderColor='';card.querySelector('.share-num').textContent='Share '+(i+1)+' / 5 ‚Äî click to copy';},2000);}).catch(()=>{});};
    grid.appendChild(card);
  });
  logLine('slog','5 shares generated ¬∑ GF(256) ¬∑ 3-of-5 threshold','ok');
}

function testRecovery() {
  try{
    const raw=document.getElementById('rec-input').value.trim();
    const hexes=raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    if(hexes.length<3){document.getElementById('rec-result').innerHTML='<span style="color:var(--gold);">‚ö† Paste at least 3 share hexes</span>';return;}
    const shares=hexes.slice(0,3).map(h=>fromHex(h));
    const rec=Shamir.combine(shares);
    const recHex=toHex(rec);
    const match=_privKeyHex&&recHex===_privKeyHex;
    document.getElementById('rec-result').innerHTML=match
      ?'<span style="color:var(--green);">‚úì Recovery PASSED ‚Äî reconstructed key matches original exactly</span>'
      :'<span style="color:var(--gold);">‚ö† Recovered: '+recHex.substr(0,32)+'‚Ä¶ (no session key to compare ‚Äî paste shares from same session)</span>';
    logLine('slog',match?'Recovery PASSED':'Recovery complete (manual verify needed)','ok');
  }catch(e){document.getElementById('rec-result').innerHTML='<span style="color:var(--red);">‚úó '+e.message+'</span>';}
}

function downloadShares() {
  if(!_shares.length){showModal('Download','Generate shares first.');return;}
  const data={bundle:'A-SovereignCustody',identity:_identity?.did||'unknown',generatedAt:new Date().toISOString(),shares:_shares.map((s,i)=>({index:i+1,hex:toHex(s)}))};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='shamir-shares-'+Date.now()+'.json';a.click();
}

// ‚îÄ‚îÄ SCMP ENGINE (AES-256 + Capability Tokens) ‚îÄ‚îÄ
const SCMPEngine = (() => {
  const _store=new Map(),_grants=new Map(),_audit=[];
  function _log(msg,cls='info'){logLine('mem-audit-log','[SCMP] '+msg,cls);logLine('cap-audit-log','[CAP] '+msg,cls);}
  async function _getMasterKey(){const seed=_identity?_identity.pubKeyHex.substr(0,64):'sovereign-bundle-a-default-key-2026';const raw=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(seed));return crypto.subtle.importKey('raw',raw,{name:'AES-GCM'},false,['encrypt','decrypt']);}
  async function _encrypt(text){const key=await _getMasterKey();const iv=crypto.getRandomValues(new Uint8Array(12));const enc=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(text));const ivHex=toHex(iv);const encHex=toHex(new Uint8Array(enc));return{ivHex,encHex};}
  async function _decrypt(encObj){const key=await _getMasterKey();const iv=fromHex(encObj.ivHex);const enc=fromHex(encObj.encHex);const dec=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,enc);return new TextDecoder().decode(dec);}
  async function sha256(str){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));return toHex(new Uint8Array(buf));}
  function _shard(encHex,size=256){const sh=[];for(let i=0;i<encHex.length;i+=size)sh.push(encHex.substr(i,size));return sh;}
  function _updateMetrics(){document.getElementById('aes-records').textContent=_store.size;let s=0;_store.forEach(r=>s+=r.shards.length);document.getElementById('aes-shards').textContent=s;document.getElementById('aes-grants').textContent=_grants.size;}
  function _renderList(){const el=document.getElementById('mem-record-list');if(!el)return;if(!_store.size){el.innerHTML='<div style="color:var(--text2);font-size:11px;">No records yet.</div>';return;}el.innerHTML='';_store.forEach((rec,id)=>{const div=document.createElement('div');div.className='card';div.innerHTML=`<div style="font-size:12px;color:var(--blue);font-weight:600;">${id}</div><div style="font-size:9px;color:var(--text2);">${rec.shards.length} shards ¬∑ ${rec.views} views ¬∑ ${new Date(rec.createdAt).toLocaleString()}</div><div class="hash" style="margin-top:4px;">sha256: ${rec.hash.substr(0,32)}‚Ä¶</div>`;el.appendChild(div);});}
  async function store(){const id=document.getElementById('mem-id')?.value.trim();const text=document.getElementById('mem-text')?.value.trim();const tags=(document.getElementById('mem-tags')?.value||'').split(',').map(t=>t.trim()).filter(Boolean);if(!id||!text){showModal('SCMP','Record ID and content required');return;}const encObj=await _encrypt(text);const hash=await sha256(encObj.encHex);const shards=_shard(encObj.encHex);_store.set(id,{enc:encObj,shards,hash,tags,createdAt:Date.now(),views:0});_log('STORE: '+id+' ¬∑ '+shards.length+' shards ¬∑ sha256:'+hash.substr(0,16),'ok');_updateMetrics();_renderList();document.getElementById('mem-id').value='';document.getElementById('mem-text').value='';document.getElementById('mem-tags').value='';}
  async function retrieve(){const id=document.getElementById('mem-get-id')?.value.trim();const token=document.getElementById('mem-cap-token')?.value.trim();const out=document.getElementById('mem-retrieve-result');if(!id){if(out)out.textContent='Enter a record ID';return;}const record=_store.get(id);if(!record){if(out)out.textContent='Record not found';_log('NOT_FOUND: '+id,'err');return;}if(token){const grant=_grants.get(token);if(!grant||grant.resourceId!==id){if(out)out.textContent='Invalid capability token';_log('DENIED: invalid token','err');return;}if(grant.expiresAt&&Date.now()>grant.expiresAt){if(out)out.textContent='Token expired';_log('DENIED: token expired','err');return;}if(grant.maxViews&&grant.viewCount>=grant.maxViews){if(out)out.textContent='View limit exceeded';_log('DENIED: view limit','err');return;}grant.viewCount++;_log('VIEW via token: views='+grant.viewCount,'info');}try{const text=await _decrypt(record.enc);record.views++;if(out)out.textContent=text;_log('ACCESS: '+id+' ¬∑ views='+record.views,'ok');}catch(e){if(out)out.textContent='Decryption failed: '+e.message;_log('ERROR: '+e.message,'err');}}
  function share(){const id=document.getElementById('mem-share-id')?.value.trim();const maxViews=parseInt(document.getElementById('mem-max-views')?.value)||3;const expiresHours=parseInt(document.getElementById('mem-expires')?.value)||24;const grantedTo=document.getElementById('mem-grant-to')?.value.trim()||'*';if(!id||!_store.has(id)){showModal('Capability','Record not found: '+id+' ‚Äî encrypt and store it first in AES Sharding tab.');return;}const tokenBytes=crypto.getRandomValues(new Uint8Array(24));const token=toHex(tokenBytes);const expiresAt=Date.now()+(expiresHours*3600000);_grants.set(token,{token,resourceId:id,grantedTo,maxViews,expiresAt,viewCount:0,createdAt:Date.now()});_log('GRANT: '+id+' ‚Üí '+grantedTo+' ¬∑ maxViews='+maxViews+' ¬∑ exp='+expiresHours+'h','ok');const tr=document.getElementById('mem-token-result');const tv=document.getElementById('mem-token-val');if(tr)tr.style.display='block';if(tv)tv.textContent=token;_updateMetrics();}
  function exportState(){const state={version:'1.0',bundle:'A-SovereignCustody',exportedAt:new Date().toISOString(),records:_store.size,grants:_grants.size,auditEntries:_audit.length,audit:_audit.slice(-50)};const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='scmp-audit-'+Date.now()+'.json';a.click();}
  function get(){return{records:_store.size,grants:_grants.size};}
  return{store,retrieve,share,exportState,get};
})();

// ‚îÄ‚îÄ BUNDLE VERIFY ‚îÄ‚îÄ
const BundleVerify = (() => {
  let _lastReport=null;
  function _set(id,result,pass){const r=document.getElementById('bv-r-'+id),b=document.getElementById('bv-b-'+id);if(r)r.innerHTML=result;if(b){b.textContent=pass===true?'PASS':pass===false?'FAIL':'WARN';b.style.color=pass===true?'var(--green)':pass===false?'var(--red)':'var(--gold)';b.style.borderColor=pass===true?'var(--green)':pass===false?'var(--red)':'var(--gold)';}}
  async function runAll(){
    const t=Date.now();
    // Entropy
    await new Promise(r=>setTimeout(r,80));
    const steps=KeccakEngine.getStepCount();
    _set('entropy',steps>0?`<span style="color:var(--green);">‚úì ${steps} Keccak sponge steps ¬∑ entropy pool active</span>`:'<span style="color:var(--gold);">‚ö† No entropy collected yet</span>',steps>0||null);
    // Identity
    await new Promise(r=>setTimeout(r,80));
    _set('identity',_identity?`<span style="color:var(--green);">‚úì Ed25519 keypair generated ¬∑ DID: ${_identity.did.substr(0,36)}‚Ä¶</span>`:'<span style="color:var(--gold);">‚ö† No identity generated yet</span>',_identity?true:null);
    // Shamir ‚Äî live test
    await new Promise(r=>setTimeout(r,80));
    if(_shares.length>=5){
      try{
        const testSecret=new Uint8Array(16);crypto.getRandomValues(testSecret);
        const sh=Shamir.split(testSecret,5,3);
        const rec=Shamir.combine([sh[0],sh[2],sh[4]]);
        const match=Array.from(testSecret).every((v,i)=>v===rec[i]);
        _set('shamir',match?`<span style="color:var(--green);">‚úì GF(256) split‚Üícombine verified ¬∑ 3-of-5 reconstruction correct</span>`:'<span style="color:var(--red);">‚úó Shamir math error</span>',match);
      }catch(e){_set('shamir','<span style="color:var(--red);">‚úó Error: '+e.message+'</span>',false);}
    } else {
      // Still test the math
      const testSecret=new Uint8Array(16);crypto.getRandomValues(testSecret);
      const sh=Shamir.split(testSecret,5,3);
      const rec=Shamir.combine([sh[0],sh[2],sh[4]]);
      const match=Array.from(testSecret).every((v,i)=>v===rec[i]);
      _set('shamir',match?`<span style="color:var(--green);">‚úì GF(256) math verified (generate shares to see live keys)</span>`:'<span style="color:var(--red);">‚úó Shamir math error</span>',match);
    }
    // AES
    await new Promise(r=>setTimeout(r,80));
    try{
      const key=await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const plain=new TextEncoder().encode('aes-test-plaintext-2026');
      const enc=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,plain);
      const dec=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,enc);
      const ok=new TextDecoder().decode(dec)==='aes-test-plaintext-2026';
      const scmp=SCMPEngine.get();
      _set('aes',ok?`<span style="color:var(--green);">‚úì AES-256-GCM encrypt‚Üídecrypt verified ¬∑ ${scmp.records} records stored ¬∑ ${scmp.grants} grants issued</span>`:'<span style="color:var(--red);">‚úó AES verification failed</span>',ok);
    }catch(e){_set('aes','<span style="color:var(--red);">‚úó '+e.message+'</span>',false);}
    // Capability
    await new Promise(r=>setTimeout(r,80));
    const scmp=SCMPEngine.get();
    _set('cap',`<span style="color:${scmp.records>0?'var(--green)':'var(--gold)'};">${scmp.records>0?'‚úì '+scmp.records+' encrypted records ¬∑ '+scmp.grants+' capability tokens issued':'‚ö† No records stored yet ‚Äî use AES Sharding tab'}</span>`,scmp.records>0||null);
    const elapsed=Date.now()-t;
    _lastReport={bundle:'A ‚Äî Sovereign Custody',generatedAt:new Date().toISOString(),elapsed:elapsed+'ms',identity:_identity?.did||'none',shamir:'5-of-5 shares generated: '+(_shares.length>=5),aes:'records: '+scmp.records,caps:'grants: '+scmp.grants};
    document.getElementById('bv-summary').style.display='block';
    document.getElementById('bv-summary').innerHTML=`<div style="background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:16px;font-family:var(--mono);font-size:10px;line-height:1.8;color:var(--text2);">Bundle A Verification ¬∑ ${new Date().toISOString()}<br>Elapsed: ${elapsed}ms<br>Identity: ${_identity?.did||'none'}<br>Shamir shares: ${_shares.length}/5<br>AES records: ${scmp.records} ¬∑ Grants: ${scmp.grants}</div>`;
  }
  function exportReport(){if(!_lastReport){showModal('Export','Run verification first.');return;}const blob=new Blob([JSON.stringify(_lastReport,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bundle-a-verify-'+Date.now()+'.json';a.click();}
  return{runAll,exportReport};
})();
</script>
</body>
</html>
