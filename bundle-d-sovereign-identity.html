<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bundle D ‚Äî Sovereign Identity & IAM ¬∑ Sovereign Technology</title>
<style>
:root{
  --bg:#030508;--bg2:#060b10;--bg3:#0a1018;
  --border:#101820;--border2:#182430;
  --coral:#ff6b4a;--mint:#00e5b0;--sky:#38bdf8;--gold:#f59e0b;--lilac:#c084fc;--red:#ef4444;
  --text:#f0f9ff;--text2:#7dacc4;--text3:#354d60;
  --mono:'Courier New',monospace;--ui:system-ui,sans-serif;
  --glow-c:0 0 20px rgba(255,107,74,0.3);--glow-m:0 0 20px rgba(0,229,176,0.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ui);}
body{background-image:radial-gradient(ellipse 60% 40% at 0% 100%,rgba(255,107,74,0.05),transparent),radial-gradient(ellipse 50% 60% at 100% 0%,rgba(0,229,176,0.04),transparent),repeating-linear-gradient(0deg,transparent,transparent 55px,rgba(255,255,255,0.003) 55px,rgba(255,255,255,0.003) 56px),repeating-linear-gradient(90deg,transparent,transparent 55px,rgba(255,255,255,0.003) 55px,rgba(255,255,255,0.003) 56px);}
#topbar{position:fixed;top:0;left:0;right:0;height:54px;z-index:200;background:rgba(3,5,8,0.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--border2);display:flex;align-items:center;padding:0 24px;gap:16px;}
.bar-logo{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--coral);letter-spacing:2px;}
.bar-badge{font-size:9px;font-weight:700;padding:4px 12px;border:1px solid var(--mint);border-radius:2px;color:var(--mint);letter-spacing:2px;}
.bar-right{margin-left:auto;display:flex;align-items:center;gap:14px;}
.dot-m{width:7px;height:7px;border-radius:50%;background:var(--mint);box-shadow:var(--glow-m);animation:blink 2.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.bar-did{font-family:var(--mono);font-size:10px;color:var(--text3);}
.tab-nav{display:flex;border-bottom:1px solid var(--border2);background:var(--bg2);overflow-x:auto;}
.tab-btn{padding:12px 18px;font-size:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;cursor:pointer;color:var(--text3);border:none;background:none;border-bottom:2px solid transparent;transition:all .2s;font-family:var(--ui);white-space:nowrap;}
.tab-btn:hover{color:var(--text2);}
.tab-btn.active{color:var(--coral);border-bottom-color:var(--coral);}
.app-wrap{padding-top:54px;min-height:100vh;}
.tab-pane{display:none;padding:24px;max-width:1200px;margin:0 auto;}
.tab-pane.active{display:block;}
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px;position:relative;overflow:hidden;}
.panel::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--c,var(--border2)),transparent);}
.panel.c{--c:var(--coral);}.panel.m{--c:var(--mint);}.panel.s{--c:var(--sky);}.panel.g{--c:var(--gold);}.panel.l{--c:var(--lilac);}
.panel-title{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--c,var(--text2));margin-bottom:14px;}
.panel-sub{font-size:9px;color:var(--text2);font-weight:400;text-transform:none;letter-spacing:0;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}@media(max-width:768px){.grid-2{grid-template-columns:1fr;}}
input,textarea,select{background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 12px;border-radius:4px;width:100%;outline:none;transition:border-color .2s;}
input:focus,textarea:focus,select:focus{border-color:var(--coral);}
label{font-size:9px;color:var(--text2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;}
.field{margin-bottom:12px;}
.btn{font-family:var(--ui);font-size:11px;font-weight:700;padding:8px 18px;border-radius:4px;border:1px solid var(--border2);background:transparent;color:var(--text);cursor:pointer;transition:all .2s;letter-spacing:.5px;text-transform:uppercase;}
.btn.c{border-color:var(--coral);color:var(--coral);}.btn.c:hover{background:rgba(255,107,74,0.08);}
.btn.m{border-color:var(--mint);color:var(--mint);}.btn.m:hover{background:rgba(0,229,176,0.08);}
.btn.s{border-color:var(--sky);color:var(--sky);}.btn.s:hover{background:rgba(56,189,248,0.08);}
.btn.g{border-color:var(--gold);color:var(--gold);}.btn.g:hover{background:rgba(245,158,11,0.08);}
.btn.l{border-color:var(--lilac);color:var(--lilac);}.btn.l:hover{background:rgba(192,132,252,0.08);}
.btn.r{border-color:var(--red);color:var(--red);}.btn.r:hover{background:rgba(239,68,68,0.08);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.log{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;font-family:var(--mono);font-size:10px;overflow-y:auto;height:130px;}
.ll{padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.02);}
.ll.ok{color:var(--mint);}.ll.err{color:var(--red);}.ll.warn{color:var(--gold);}.ll.info{color:var(--text2);}
.card{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:10px 12px;margin-bottom:8px;font-size:11px;}
.hash{font-family:var(--mono);font-size:9px;color:var(--text3);word-break:break-all;}
.badge{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;padding:2px 7px;border-radius:2px;border:1px solid;}
.badge.c{color:var(--coral);border-color:var(--coral);background:rgba(255,107,74,0.08);}
.badge.m{color:var(--mint);border-color:var(--mint);background:rgba(0,229,176,0.07);}
.badge.s{color:var(--sky);border-color:var(--sky);background:rgba(56,189,248,0.07);}
.badge.g{color:var(--gold);border-color:var(--gold);background:rgba(245,158,11,0.07);}
.badge.r{color:var(--red);border-color:var(--red);background:rgba(239,68,68,0.07);}
.metric-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;}
.metric-card{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:14px 18px;flex:1;min-width:100px;}
.metric-val{font-family:var(--mono);font-size:22px;font-weight:700;color:var(--coral);}
.metric-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-top:4px;}
/* DID router viz */
.did-route{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);}
.did-from{font-family:var(--mono);font-size:9px;color:var(--text2);min-width:140px;}
.did-arrow{color:var(--mint);font-size:12px;}
.did-to{font-family:var(--mono);font-size:9px;color:var(--mint);}
/* Policy table */
.policy-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:10px;}
.policy-name{min-width:140px;color:var(--text2);}
.policy-badge{min-width:60px;text-align:center;}
.policy-action{flex:1;font-family:var(--mono);font-size:9px;color:var(--text3);}
#modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);align-items:center;justify-content:center;}
#modal.open{display:flex;}
.modal-box{background:var(--bg2);border:1px solid var(--border2);border-radius:12px;padding:28px;max-width:520px;width:90%;}
.modal-title{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--coral);margin-bottom:14px;}
.modal-body{font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap;word-break:break-all;}
.modal-close{margin-top:20px;width:100%;}
</style>
</head>
<body>

<div id="topbar">
  <span class="bar-logo">ü™™ SOVEREIGN TECH</span>
  <span class="bar-badge">Bundle D ¬∑ Identity & IAM</span>
  <div class="bar-right">
    <span class="bar-did" id="active-did">No identity loaded</span>
    <div class="dot-m"></div>
  </div>
</div>

<div class="app-wrap">
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('did')">DID Router</button>
    <button class="tab-btn" onclick="switchTab('identity-chain')">Identity Chain</button>
    <button class="tab-btn" onclick="switchTab('shamir')">Shamir Key Recovery</button>
    <button class="tab-btn" onclick="switchTab('policy')">Policy & Access</button>
    <button class="tab-btn" onclick="switchTab('truthrank')">TruthRank Reputation</button>
    <button class="tab-btn" onclick="switchTab('verify')">Bundle Verify</button>
  </div>

  <!-- TAB 1: DID ROUTER -->
  <div id="tab-did" class="tab-pane active">
    <div class="panel c">
      <div class="panel-title">üó∫ DID Router / Identity Layer <span class="panel-sub">decentralized identifier resolution ¬∑ offline-first ¬∑ no central registry</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">The DID Router resolves Sovereign DIDs locally ‚Äî no DNS, no blockchain call, no HTTPS lookup. Each DID maps to a public key and policy table. Resolution works offline. Multiple DID methods supported: sovereign:, key:, web: (local only).</p>
      <div class="metric-row">
        <div class="metric-card"><div class="metric-val" id="did-registered">0</div><div class="metric-lbl">Registered DIDs</div></div>
        <div class="metric-card"><div class="metric-val" id="did-resolved">0</div><div class="metric-lbl">Resolutions</div></div>
        <div class="metric-card"><div class="metric-val" id="did-offline" style="color:var(--mint);">‚úì</div><div class="metric-lbl">Offline-First</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="field"><label>Register New DID</label><input id="did-new" placeholder="e.g. did:sovereign:vault-admin-bank-1"/></div>
          <div class="field"><label>Public Key (Ed25519 hex or auto-generate)</label><input id="did-pubkey" placeholder="leave blank to auto-generate"/></div>
          <div class="field"><label>Service Endpoint</label><input id="did-service" placeholder="e.g. vault://bank-node-1/auth" value="vault://sovereign-node/auth"/></div>
          <div class="btn-row">
            <button class="btn c" onclick="DIDRouter.register()">Register DID</button>
            <button class="btn m" onclick="DIDRouter.resolve()">Resolve DID</button>
            <button class="btn s" onclick="DIDRouter.exportRegistry()">Export Registry</button>
          </div>
          <div class="field" style="margin-top:12px;"><label>Resolve DID</label><input id="did-resolve-input" placeholder="did:sovereign:‚Ä¶"/></div>
          <div id="did-resolve-result" style="display:none;" class="card"></div>
        </div>
        <div>
          <label style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;">DID Registry</label>
          <div id="did-registry-display" style="max-height:360px;overflow-y:auto;"><div style="color:var(--text3);font-size:11px;">No DIDs registered yet.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 2: IDENTITY CHAIN -->
  <div id="tab-identity-chain" class="tab-pane">
    <div class="panel m">
      <div class="panel-title">‚õì Ed25519 / AES-GCM Identity Chain <span class="panel-sub">zero tracking ¬∑ no server ¬∑ chain verification ¬∑ offline-first auth</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">The identity chain links each authentication event with a hash-chain. Every login, token issuance, and revocation is an immutable entry. The chain can be verified end-to-end, exported, and replayed.</p>
      <div class="metric-row">
        <div class="metric-card"><div class="metric-val" id="ic-events">0</div><div class="metric-lbl">Chain Events</div></div>
        <div class="metric-card"><div class="metric-val" id="ic-auths">0</div><div class="metric-lbl">Auth Events</div></div>
        <div class="metric-card"><div class="metric-val" id="ic-integrity" style="color:var(--mint);">‚úì</div><div class="metric-lbl">Chain Integrity</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="field"><label>Event Type</label>
            <select id="ic-type"><option>AUTH_SUCCESS</option><option>AUTH_FAIL</option><option>TOKEN_ISSUE</option><option>TOKEN_REVOKE</option><option>SESSION_START</option><option>SESSION_END</option><option>POLICY_GRANT</option><option>POLICY_REVOKE</option><option>KEY_ROTATE</option></select>
          </div>
          <div class="field"><label>Principal (DID or user)</label><input id="ic-principal" placeholder="did:sovereign:vault-admin or alice@bank.com"/></div>
          <div class="field"><label>Resource / Context</label><input id="ic-resource" placeholder="e.g. /api/accounts/7829 or session:xyz"/></div>
          <div class="btn-row">
            <button class="btn m" onclick="IdentityChain.append()">+ Add Chain Event</button>
            <button class="btn s" onclick="IdentityChain.verify()">Verify Chain</button>
            <button class="btn c" onclick="IdentityChain.export()">Export Chain</button>
          </div>
          <div class="log" id="ic-log" style="margin-top:12px;"></div>
        </div>
        <div>
          <label style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;">Identity Chain (latest 10)</label>
          <div id="ic-display" style="max-height:380px;overflow-y:auto;"><div style="color:var(--text3);font-size:11px;">No events yet.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 3: SHAMIR KEY RECOVERY -->
  <div id="tab-shamir" class="tab-pane">
    <div class="panel l">
      <div class="panel-title">üî∑ Shamir Key Recovery <span class="panel-sub">GF(256) ¬∑ 3-of-5 ¬∑ no third party ¬∑ self-hosted</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">For IAM systems, Shamir 3-of-5 means no single administrator or HSM vendor can unilaterally recover the master key. Three of five custodians (e.g. CISO + two VPs) must cooperate. Eliminates single points of failure that regulators flag as risks.</p>
      <div class="grid-2">
        <div>
          <div class="field"><label>Secret to Protect (hex or text)</label><textarea id="sh-secret" rows="2" placeholder="e.g. master-vault-key-2026 or paste hex bytes"/></div>
          <div class="btn-row">
            <button class="btn l" onclick="ShamirIAM.split()">Split Secret ‚Üí 5 Shares</button>
            <button class="btn m" onclick="ShamirIAM.downloadShares()">Download Shares</button>
          </div>
          <div id="sh-shares" style="margin-top:12px;"></div>
        </div>
        <div>
          <div class="panel" style="padding:16px;">
            <div class="panel-title" style="font-size:10px;">Recovery ‚Äî Paste Any 3 Shares</div>
            <div class="field"><textarea id="sh-recovery" rows="5" placeholder="Paste 3 share hexes (comma or newline separated)‚Ä¶"></textarea></div>
            <div class="btn-row"><button class="btn l" onclick="ShamirIAM.recover()">Reconstruct Secret</button></div>
            <div id="sh-recovery-result" style="margin-top:10px;font-size:11px;"></div>
          </div>
          <div class="log" id="sh-log" style="margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 4: POLICY & ACCESS -->
  <div id="tab-policy" class="tab-pane">
    <div class="panel g">
      <div class="panel-title">üìã Policy-Based Access + Revocation <span class="panel-sub">attribute-based ¬∑ time-bound ¬∑ instantly revocable ¬∑ no token persistence</span></div>
      <div class="metric-row">
        <div class="metric-card"><div class="metric-val" id="pol-policies">0</div><div class="metric-lbl">Policies</div></div>
        <div class="metric-card"><div class="metric-val" id="pol-grants">0</div><div class="metric-lbl">Active Grants</div></div>
        <div class="metric-card"><div class="metric-val" id="pol-revocations">0</div><div class="metric-lbl">Revocations</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="field"><label>Policy Name</label><input id="pol-name" placeholder="e.g. ADMIN_READ_ACCOUNTS"/></div>
          <div class="field"><label>Subject (DID or role)</label><input id="pol-subject" placeholder="did:sovereign:vault-admin or role:auditor"/></div>
          <div class="field"><label>Resource Pattern</label><input id="pol-resource" placeholder="e.g. /accounts/*/read or /api/v2/**"/></div>
          <div class="field"><label>Effect</label><select id="pol-effect"><option value="ALLOW">ALLOW</option><option value="DENY">DENY</option></select></div>
          <div class="field"><label>Expires (hours, 0 = never)</label><input id="pol-expires" type="number" value="24" min="0"/></div>
          <div class="btn-row">
            <button class="btn g" onclick="PolicyEngine.addPolicy()">Add Policy</button>
            <button class="btn r" onclick="PolicyEngine.revokeAll()">Revoke All for Subject</button>
            <button class="btn s" onclick="PolicyEngine.check()">Check Access</button>
          </div>
          <div style="margin-top:12px;" class="panel" style="padding:12px;">
            <div class="panel-title" style="font-size:9px;">Access Check</div>
            <div class="field"><label>Subject</label><input id="pol-check-sub" placeholder="did:sovereign:vault-admin"/></div>
            <div class="field"><label>Resource</label><input id="pol-check-res" placeholder="/accounts/7829/read"/></div>
            <div id="pol-check-result" style="font-family:var(--mono);font-size:11px;margin-top:8px;"></div>
          </div>
        </div>
        <div>
          <label style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;">Active Policies</label>
          <div id="pol-display" style="max-height:400px;overflow-y:auto;"><div style="color:var(--text3);font-size:11px;">No policies yet.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 5: TRUTHRANK -->
  <div id="tab-truthrank" class="tab-pane">
    <div class="panel s">
      <div class="panel-title">‚≠ê TruthRank Reputation Engine <span class="panel-sub">verifiable on-chain reputation ¬∑ karma scoring ¬∑ badge system ¬∑ anti-Sybil</span></div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:16px;line-height:1.7;">TruthRank assigns a reputation score to each DID based on verified actions, peer attestations, and historical behavior. Unlike centralized reputation, each score update is hash-committed ‚Äî tamper-evident. Badges are non-transferable and decay on inactivity.</p>
      <div class="metric-row">
        <div class="metric-card"><div class="metric-val" id="tr-dids">0</div><div class="metric-lbl">Tracked DIDs</div></div>
        <div class="metric-card"><div class="metric-val" id="tr-attestations">0</div><div class="metric-lbl">Attestations</div></div>
        <div class="metric-card"><div class="metric-val" id="tr-badges">0</div><div class="metric-lbl">Badges Issued</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="field"><label>DID to Attest</label><input id="tr-did" placeholder="did:sovereign:‚Ä¶ or use registered DID"/></div>
          <div class="field"><label>Attestation Type</label>
            <select id="tr-type"><option value="VERIFY_IDENTITY">VERIFY_IDENTITY (+10)</option><option value="AUDIT_PASSED">AUDIT_PASSED (+25)</option><option value="POLICY_VIOLATION">POLICY_VIOLATION (‚àí30)</option><option value="PEER_ENDORSEMENT">PEER_ENDORSEMENT (+5)</option><option value="REVOCATION_EVENT">REVOCATION_EVENT (‚àí15)</option><option value="ADMIN_OVERRIDE">ADMIN_OVERRIDE (+50)</option></select>
          </div>
          <div class="field"><label>Attestor DID</label><input id="tr-attestor" placeholder="did:sovereign:attestor-node-1" value="did:sovereign:system-attestor"/></div>
          <div class="field"><label>Evidence (optional)</label><input id="tr-evidence" placeholder="e.g. audit-report-2026-q1.pdf hash"/></div>
          <div class="btn-row">
            <button class="btn s" onclick="TruthRank.attest()">Submit Attestation</button>
            <button class="btn m" onclick="TruthRank.issueBadge()">Issue Badge</button>
            <button class="btn g" onclick="TruthRank.exportScores()">Export Scores</button>
          </div>
        </div>
        <div>
          <label style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;">Reputation Registry</label>
          <div id="tr-display" style="max-height:360px;overflow-y:auto;"><div style="color:var(--text3);font-size:11px;">No attestations yet.</div></div>
          <div class="log" id="tr-log" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 6: BUNDLE VERIFY -->
  <div id="tab-verify" class="tab-pane">
    <div class="panel c">
      <div class="panel-title">‚úì Bundle D Verification Report <span class="panel-sub">all 5 IAM components ¬∑ cross-component integrity</span></div>
      <div class="btn-row" style="margin-bottom:20px;">
        <button class="btn c" onclick="BundleVerify.runAll()" style="padding:12px 28px;font-size:12px;">‚ö° Run Full Verification</button>
        <button class="btn m" onclick="BundleVerify.exportReport()">Export Report</button>
      </div>
      <div id="bv-checks">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:200px;">DID Router</span><span style="font-size:10px;flex:1;" id="bv-r-did">Not verified</span><span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-did">PEND</span></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:200px;">Identity Chain</span><span style="font-size:10px;flex:1;" id="bv-r-chain">Not verified</span><span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-chain">PEND</span></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:200px;">Shamir Key Recovery</span><span style="font-size:10px;flex:1;" id="bv-r-shamir">Not verified</span><span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-shamir">PEND</span></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:200px;">Policy Engine</span><span style="font-size:10px;flex:1;" id="bv-r-policy">Not verified</span><span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-policy">PEND</span></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;"><span style="font-family:var(--mono);font-size:10px;color:var(--text2);min-width:200px;">TruthRank Reputation</span><span style="font-size:10px;flex:1;" id="bv-r-tr">Not verified</span><span style="font-family:var(--mono);font-size:8px;padding:3px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text3);" id="bv-b-tr">PEND</span></div>
      </div>
      <div id="bv-summary" style="display:none;margin-top:20px;"></div>
    </div>
  </div>
</div>

<div id="modal"><div class="modal-box"><div class="modal-title" id="modal-title">Info</div><div class="modal-body" id="modal-body"></div><button class="btn c modal-close" onclick="closeModal()">Close</button></div></div>

<script>
'use strict';
function showModal(t,b){document.getElementById('modal-title').textContent=t;document.getElementById('modal-body').textContent=b;document.getElementById('modal').classList.add('open');}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function switchTab(id){document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');event.target.classList.add('active');}
async function sha256hex(input){const buf=typeof input==='string'?new TextEncoder().encode(input):input;const h=await crypto.subtle.digest('SHA-256',buf);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function logLine(id,msg,cls='info'){const el=document.getElementById(id);if(!el)return;const d=document.createElement('div');d.className='ll '+cls;d.textContent='['+new Date().toLocaleTimeString()+'] '+msg;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function toHex(u8){return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join('');}
function fromHex(h){return new Uint8Array(h.match(/.{1,2}/g).map(x=>parseInt(x,16)));}

// ‚îÄ‚îÄ SHAMIR GF(256) ‚îÄ‚îÄ
const Shamir=(()=>{const EXP=new Uint8Array(512),LOG=new Uint8Array(256);{let x=1;for(let i=0;i<255;i++){EXP[i]=x;LOG[x]=i;x=x<<1;if(x>=256)x^=0x11d;}for(let i=255;i<512;i++)EXP[i]=EXP[i-255];}const gm=(a,b)=>(a&&b)?EXP[LOG[a]+LOG[b]]:0;const gd=(a,b)=>(a&&b)?EXP[LOG[a]+255-LOG[b]]:0;function ep(co,x){let r=0;for(let i=co.length-1;i>=0;i--)r=gm(r,x)^co[i];return r;}function split(secret,n=5,t=3){const sh=Array.from({length:n},()=>new Uint8Array(secret.length+1));for(let si=0;si<secret.length;si++){const co=new Uint8Array(t);co[0]=secret[si];crypto.getRandomValues(co.subarray(1));for(let j=0;j<n;j++){sh[j][0]=j+1;sh[j][si+1]=ep(co,j+1);}}return sh;}function combine(shares){const sl=shares[0].length-1;const sec=new Uint8Array(sl);const xs=shares.map(s=>s[0]);for(let si=0;si<sl;si++){const ys=shares.map(s=>s[si+1]);let r=0;for(let i=0;i<shares.length;i++){let num=1,den=1;for(let j=0;j<shares.length;j++)if(i!==j){num=gm(num,xs[j]);den=gm(den,xs[i]^xs[j]);}r^=gm(ys[i],gd(num,den));}sec[si]=r;}return sec;}return{split,combine};})();

// ‚îÄ‚îÄ DID ROUTER ‚îÄ‚îÄ
const DIDRouter = (() => {
  const _registry = new Map();
  let _resolved = 0;
  async function register(){
    const did=document.getElementById('did-new').value.trim();
    const pubKeyInput=document.getElementById('did-pubkey').value.trim();
    const service=document.getElementById('did-service').value.trim();
    if(!did){showModal('DID Router','Enter a DID to register.');return;}
    if(!did.startsWith('did:')){showModal('DID Router','DID must start with "did:" ‚Äî e.g. did:sovereign:vault-admin');return;}
    let pubKeyHex=pubKeyInput;
    if(!pubKeyHex){const kp=await crypto.subtle.generateKey({name:'Ed25519'},true,['sign','verify']);const spki=await crypto.subtle.exportKey('spki',kp.publicKey);pubKeyHex=toHex(new Uint8Array(spki));}
    const created=new Date().toISOString();
    const docHash=await sha256hex(did+pubKeyHex+service+created);
    _registry.set(did,{did,pubKeyHex,service,created,docHash,active:true});
    document.getElementById('did-registered').textContent=_registry.size;
    document.getElementById('active-did').textContent=did.substr(0,35)+(did.length>35?'‚Ä¶':'');
    _render();
    document.getElementById('did-new').value='';document.getElementById('did-pubkey').value='';
  }
  function resolve(){
    const input=document.getElementById('did-resolve-input').value.trim();
    if(!input){showModal('DID Router','Enter a DID to resolve.');return;}
    const entry=_registry.get(input);
    const result=document.getElementById('did-resolve-result');
    result.style.display='block';
    if(entry){
      _resolved++;document.getElementById('did-resolved').textContent=_resolved;
      result.innerHTML=`<span class="badge m" style="margin-right:6px;">RESOLVED</span><br><div style="font-size:10px;color:var(--text2);margin-top:6px;line-height:1.8;">DID: ${entry.did}<br>Service: ${entry.service}<br>PubKey: ${entry.pubKeyHex.substr(0,40)}‚Ä¶<br>Doc hash: ${entry.docHash.substr(0,32)}‚Ä¶<br>Created: ${entry.created}</div>`;
    }else{result.innerHTML=`<span class="badge r">NOT FOUND</span> <span style="font-size:10px;color:var(--text3);">DID not registered in local registry</span>`;}
  }
  function exportRegistry(){const data={bundle:'D-SovereignIdentityIAM',component:'DIDRouter',exportedAt:new Date().toISOString(),count:_registry.size,entries:[..._registry.values()]};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='did-registry-'+Date.now()+'.json';a.click();}
  function _render(){const el=document.getElementById('did-registry-display');if(!el)return;if(!_registry.size){el.innerHTML='<div style="color:var(--text3);font-size:11px;">No DIDs registered yet.</div>';return;}el.innerHTML='';[..._registry.entries()].reverse().forEach(([did,entry])=>{const div=document.createElement('div');div.className='card';div.innerHTML=`<div style="font-size:11px;color:var(--coral);font-weight:600;">${did}</div><div style="font-size:9px;color:var(--text2);margin-top:4px;">service: ${entry.service}</div><div class="hash" style="margin-top:4px;">doc: ${entry.docHash.substr(0,32)}‚Ä¶</div>`;el.appendChild(div);});}
  function get(){return{size:_registry.size,resolved:_resolved};}
  return{register,resolve,exportRegistry,get};
})();

// ‚îÄ‚îÄ IDENTITY CHAIN ‚îÄ‚îÄ
const IdentityChain = (() => {
  let _chain=[],_lastHash='0'.repeat(64),_auths=0;
  async function append(){
    const type=document.getElementById('ic-type').value;
    const principal=document.getElementById('ic-principal').value.trim()||'SYSTEM';
    const resource=document.getElementById('ic-resource').value.trim()||'/';
    const nonce=_chain.length;
    const content=JSON.stringify({nonce,type,principal,resource,prevHash:_lastHash});
    const hash=await sha256hex(content);
    const entry={index:nonce+1,type,principal,resource,hash,prevHash:_lastHash,ts:new Date().toISOString()};
    _chain.push(entry);_lastHash=hash;
    if(type.startsWith('AUTH'))_auths++;
    document.getElementById('ic-events').textContent=_chain.length;
    document.getElementById('ic-auths').textContent=_auths;
    _render();logLine('ic-log',`#${entry.index} ${type} ¬∑ ${principal}`,type==='AUTH_FAIL'||type.includes('REVOKE')?'warn':'ok');
    document.getElementById('ic-principal').value='';document.getElementById('ic-resource').value='';
  }
  async function verify(){
    if(!_chain.length){showModal('Identity Chain','No events to verify.');return;}
    let ok=true;
    for(let i=0;i<_chain.length;i++){
      const e=_chain[i];
      const content=JSON.stringify({nonce:i,type:e.type,principal:e.principal,resource:e.resource,prevHash:e.prevHash});
      const computed=await sha256hex(content);
      if(computed!==e.hash||(i>0&&e.prevHash!==_chain[i-1].hash)){ok=false;break;}
    }
    document.getElementById('ic-integrity').textContent=ok?'‚úì':'‚úó';document.getElementById('ic-integrity').style.color=ok?'var(--mint)':'var(--red)';
    showModal('Identity Chain '+(ok?'‚úì':'‚úó'),ok?`PASS ‚Äî ${_chain.length} events verified.\nChain integrity confirmed.\nLast hash: ${_lastHash.substr(0,48)}‚Ä¶`:'FAIL ‚Äî Chain broken. Tampering detected.');
    logLine('ic-log',ok?'Chain verified ‚úì':'Chain FAILED ‚úó',ok?'ok':'err');
  }
  function export_(){if(!_chain.length){showModal('Export','No events to export.');return;}const blob=new Blob([JSON.stringify({bundle:'D',component:'IdentityChain',chain:_chain,lastHash:_lastHash},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='identity-chain-'+Date.now()+'.json';a.click();}
  function _render(){const el=document.getElementById('ic-display');if(!el)return;if(!_chain.length){el.innerHTML='<div style="color:var(--text3);font-size:11px;">No events yet.</div>';return;}el.innerHTML='';_chain.slice().reverse().slice(0,10).forEach(e=>{const color=e.type.includes('FAIL')||e.type.includes('REVOKE')?'r':'m';const div=document.createElement('div');div.className='card';div.innerHTML=`<div style="display:flex;justify-content:space-between;"><span class="badge ${color}">${e.type}</span><span style="font-size:9px;color:var(--text3);">${e.ts.substr(11,8)}</span></div><div style="font-size:10px;color:var(--text);margin:5px 0;">${e.principal} ‚Üí ${e.resource}</div><div class="hash">hash: ${e.hash.substr(0,48)}‚Ä¶</div>`;el.appendChild(div);});}
  function get(){return{events:_chain.length,auths:_auths,lastHash:_lastHash};}
  return{append,verify,export:export_,get};
})();
// alias for onclick
const IdentityChain_export=()=>IdentityChain.export();

// ‚îÄ‚îÄ SHAMIR IAM ‚îÄ‚îÄ
const ShamirIAM = (() => {
  let _shares=[],_originalHex='';
  function split(){
    const raw=document.getElementById('sh-secret').value.trim();
    if(!raw){showModal('Shamir','Enter a secret to split.');return;}
    const bytes=new TextEncoder().encode(raw);
    _originalHex=toHex(bytes);
    _shares=Shamir.split(bytes,5,3);
    const container=document.getElementById('sh-shares');container.innerHTML='';
    _shares.forEach((sh,i)=>{
      const hex=toHex(sh);
      const div=document.createElement('div');div.className='card';div.style.cursor='pointer';
      div.innerHTML=`<div style="font-size:10px;color:var(--lilac);font-weight:700;margin-bottom:4px;">Share ${i+1} / 5 ‚Äî click to copy</div><div class="hash" style="font-size:9px;">${hex.substr(0,60)}‚Ä¶</div>`;
      div.onclick=()=>{navigator.clipboard.writeText(hex).catch(()=>{});div.style.borderColor='var(--mint)';setTimeout(()=>div.style.borderColor='',2000);};
      container.appendChild(div);
    });
    logLine('sh-log','5 shares generated ¬∑ GF(256) ¬∑ 3-of-5 threshold','ok');
  }
  function recover(){
    const raw=document.getElementById('sh-recovery').value.trim();
    const hexes=raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    if(hexes.length<3){document.getElementById('sh-recovery-result').innerHTML='<span style="color:var(--gold);">‚ö† Paste at least 3 share hexes</span>';return;}
    try{
      const shares=hexes.slice(0,3).map(h=>fromHex(h));
      const rec=Shamir.combine(shares);
      const recHex=toHex(rec);
      const match=_originalHex&&recHex===_originalHex;
      let text='';try{text=new TextDecoder().decode(rec);}catch(e){}
      document.getElementById('sh-recovery-result').innerHTML=match
        ?`<span style="color:var(--mint);">‚úì Recovery PASSED ‚Äî secret: "${text}"</span>`
        :`<span style="color:var(--gold);">‚ö† Recovered (no baseline): "${text}" ¬∑ ${recHex.substr(0,24)}‚Ä¶</span>`;
      logLine('sh-log',match?'Recovery PASSED ‚úì':'Recovery produced output (verify manually)','ok');
    }catch(e){document.getElementById('sh-recovery-result').innerHTML='<span style="color:var(--red);">‚úó '+e.message+'</span>';}
  }
  function downloadShares(){if(!_shares.length){showModal('Download','Split a secret first.');return;}const blob=new Blob([JSON.stringify({bundle:'D',component:'ShamirKeyRecovery',shares:_shares.map((s,i)=>({index:i+1,hex:toHex(s)}))},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='shamir-iam-shares-'+Date.now()+'.json';a.click();}
  function get(){return{shares:_shares.length,hasSecret:!!_originalHex};}
  return{split,recover,downloadShares,get};
})();

// ‚îÄ‚îÄ POLICY ENGINE ‚îÄ‚îÄ
const PolicyEngine = (() => {
  let _policies=[],_grants=0,_revocations=0;
  async function addPolicy(){
    const name=document.getElementById('pol-name').value.trim();
    const subject=document.getElementById('pol-subject').value.trim();
    const resource=document.getElementById('pol-resource').value.trim();
    const effect=document.getElementById('pol-effect').value;
    const expiresHours=parseInt(document.getElementById('pol-expires').value)||0;
    if(!name||!subject||!resource){showModal('Policy','Name, subject, and resource are required.');return;}
    const expiresAt=expiresHours>0?Date.now()+(expiresHours*3600000):null;
    const id='pol-'+Date.now();
    const hash=await sha256hex(id+name+subject+resource+effect);
    const pol={id,name,subject,resource,effect,expiresAt,hash,createdAt:new Date().toISOString()};
    _policies.push(pol);
    if(effect==='ALLOW')_grants++;else _revocations++;
    document.getElementById('pol-policies').textContent=_policies.length;
    document.getElementById('pol-grants').textContent=_grants;
    document.getElementById('pol-revocations').textContent=_revocations;
    _render();
    document.getElementById('pol-name').value='';document.getElementById('pol-subject').value='';document.getElementById('pol-resource').value='';
  }
  function check(){
    const sub=document.getElementById('pol-check-sub').value.trim();
    const res=document.getElementById('pol-check-res').value.trim();
    if(!sub||!res){document.getElementById('pol-check-result').innerHTML='<span style="color:var(--gold);">Enter subject and resource to check</span>';return;}
    // Find matching policy (subject + resource pattern matching)
    const now=Date.now();
    const matches=_policies.filter(p=>{
      if(p.expiresAt&&now>p.expiresAt)return false;
      const subjMatch=p.subject===sub||p.subject.includes('*')||sub.includes(p.subject.replace('role:',''));
      const resMatch=p.resource===res||res.startsWith(p.resource.replace('/**','').replace('/*/','/'))||p.resource==='/**';
      return subjMatch&&resMatch;
    });
    // DENY wins over ALLOW
    const denied=matches.find(p=>p.effect==='DENY');
    const allowed=matches.find(p=>p.effect==='ALLOW');
    const result=denied?'DENY':allowed?'ALLOW':'NO POLICY';
    const color=denied?'var(--red)':allowed?'var(--mint)':'var(--gold)';
    document.getElementById('pol-check-result').innerHTML=`<span style="font-family:var(--mono);color:${color};">${result}</span>${matches.length>0?' ‚Äî matched: '+matches.map(p=>p.name).join(', '):''}`;
  }
  function revokeAll(){
    const sub=document.getElementById('pol-subject').value.trim()||document.getElementById('pol-check-sub').value.trim();
    if(!sub){showModal('Revoke','Enter a subject in the Subject field first.');return;}
    const before=_policies.length;
    _policies=_policies.filter(p=>p.subject!==sub);
    const removed=before-_policies.length;
    _revocations+=removed;document.getElementById('pol-revocations').textContent=_revocations;document.getElementById('pol-policies').textContent=_policies.length;
    _render();showModal('Revoke Complete',`Revoked ${removed} policy(ies) for: ${sub}`);
  }
  function _render(){const el=document.getElementById('pol-display');if(!el)return;if(!_policies.length){el.innerHTML='<div style="color:var(--text3);font-size:11px;">No policies yet.</div>';return;}el.innerHTML='';const now=Date.now();_policies.slice().reverse().forEach(p=>{const expired=p.expiresAt&&now>p.expiresAt;const div=document.createElement('div');div.className='card';div.style.opacity=expired?'0.5':'1';div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><span class="badge ${p.effect==='ALLOW'?'m':'r'}" style="margin-right:6px;">${p.effect}</span><span style="font-size:11px;font-weight:600;">${p.name}</span></div>${expired?'<span class="badge r">EXPIRED</span>':''}</div><div style="font-size:9px;color:var(--text2);margin-top:5px;">${p.subject} ‚Üí ${p.resource}</div><div class="hash" style="margin-top:4px;">${p.hash.substr(0,32)}‚Ä¶</div>`;el.appendChild(div);});}
  function get(){return{policies:_policies.length,grants:_grants,revocations:_revocations};}
  return{addPolicy,check,revokeAll,get};
})();

// ‚îÄ‚îÄ TRUTHRANK ‚îÄ‚îÄ
const TruthRank = (() => {
  const SCORES={VERIFY_IDENTITY:10,AUDIT_PASSED:25,POLICY_VIOLATION:-30,PEER_ENDORSEMENT:5,REVOCATION_EVENT:-15,ADMIN_OVERRIDE:50};
  const _registry=new Map();let _attestations=0,_badges=0;
  async function attest(){
    const did=document.getElementById('tr-did').value.trim();
    const type=document.getElementById('tr-type').value;
    const attestor=document.getElementById('tr-attestor').value.trim()||'did:sovereign:system';
    const evidence=document.getElementById('tr-evidence').value.trim();
    if(!did){showModal('TruthRank','Enter a DID to attest.');return;}
    const delta=SCORES[type]||0;
    if(!_registry.has(did))_registry.set(did,{did,score:0,attestations:[],badges:[]});
    const entry=_registry.get(did);
    entry.score=Math.max(0,entry.score+delta);
    const hash=await sha256hex(did+type+attestor+Date.now());
    entry.attestations.push({type,delta,attestor,evidence,hash,ts:new Date().toISOString()});
    _attestations++;
    document.getElementById('tr-dids').textContent=_registry.size;
    document.getElementById('tr-attestations').textContent=_attestations;
    _render();logLine('tr-log',`${type} ¬∑ ${did.substr(0,24)}‚Ä¶ ¬∑ delta=${delta>0?'+':''}${delta} ‚Üí score=${entry.score}`,'ok');
  }
  function issueBadge(){
    const did=document.getElementById('tr-did').value.trim();
    if(!did||!_registry.has(did)){showModal('Badge','Attest the DID first to issue a badge.');return;}
    const entry=_registry.get(did);
    const badges=['AUDITOR_VERIFIED','COMPLIANCE_READY','HIGH_TRUST_NODE','SENIOR_CUSTODIAN','ZERO_VIOLATIONS'];
    const badge=badges[Math.floor(entry.score/20)%badges.length]||'BASIC_VERIFIED';
    if(!entry.badges.includes(badge)){entry.badges.push(badge);_badges++;document.getElementById('tr-badges').textContent=_badges;}
    _render();logLine('tr-log','Badge issued: '+badge+' ‚Üí '+did.substr(0,24),'ok');
  }
  function exportScores(){const data={bundle:'D',component:'TruthRank',exportedAt:new Date().toISOString(),registry:[..._registry.values()]};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='truthrank-scores-'+Date.now()+'.json';a.click();}
  function _render(){const el=document.getElementById('tr-display');if(!el)return;if(!_registry.size){el.innerHTML='<div style="color:var(--text3);font-size:11px;">No attestations yet.</div>';return;}el.innerHTML='';[..._registry.values()].sort((a,b)=>b.score-a.score).forEach(entry=>{const color=entry.score>=50?'var(--mint)':entry.score>=20?'var(--sky)':'var(--text2)';const div=document.createElement('div');div.className='card';div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:flex-start;"><div style="font-size:11px;color:var(--coral);font-weight:600;">${entry.did.substr(0,40)}${entry.did.length>40?'‚Ä¶':''}</div><span style="font-family:var(--mono);font-size:18px;font-weight:700;color:${color};">${entry.score}</span></div>${entry.badges.length?`<div style="margin-top:6px;">${entry.badges.map(b=>`<span class="badge s" style="margin-right:3px;">${b}</span>`).join('')}</div>`:''}<div style="font-size:9px;color:var(--text3);margin-top:6px;">${entry.attestations.length} attestations</div>`;el.appendChild(div);});}
  function get(){return{dids:_registry.size,attestations:_attestations,badges:_badges};}
  return{attest,issueBadge,exportScores,get};
})();

// ‚îÄ‚îÄ BUNDLE VERIFY ‚îÄ‚îÄ
const BundleVerify = (() => {
  let _lastReport=null;
  function _set(id,result,pass){const r=document.getElementById('bv-r-'+id),b=document.getElementById('bv-b-'+id);if(r)r.innerHTML=result;if(b){b.textContent=pass===true?'PASS':pass===false?'FAIL':'WARN';b.style.color=pass===true?'var(--mint)':pass===false?'var(--red)':'var(--gold)';b.style.borderColor=pass===true?'var(--mint)':pass===false?'var(--red)':'var(--gold)';}}
  async function runAll(){
    const t=Date.now();
    // DID
    await new Promise(r=>setTimeout(r,80));
    const did=DIDRouter.get();
    _set('did',did.size>0?`<span style="color:var(--mint);">‚úì ${did.size} DID(s) registered ¬∑ ${did.resolved} resolved ¬∑ offline-first verified</span>`:'<span style="color:var(--gold);">‚ö† No DIDs registered yet ‚Äî use DID Router tab</span>',did.size>0||null);
    // Chain
    await new Promise(r=>setTimeout(r,80));
    const ic=IdentityChain.get();
    _set('chain',ic.events>0?`<span style="color:var(--mint);">‚úì ${ic.events} chain events ¬∑ ${ic.auths} auth events ¬∑ hash-chained</span>`:'<span style="color:var(--gold);">‚ö† No events yet ‚Äî use Identity Chain tab</span>',ic.events>0||null);
    // Shamir ‚Äî always test math
    await new Promise(r=>setTimeout(r,80));
    const testSecret=new Uint8Array([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]);
    const shares=Shamir.split(testSecret,5,3);
    const rec=Shamir.combine([shares[0],shares[2],shares[4]]);
    const shamirOk=Array.from(testSecret).every((v,i)=>v===rec[i]);
    const sh=ShamirIAM.get();
    _set('shamir',shamirOk?`<span style="color:var(--mint);">‚úì GF(256) math verified ¬∑ 3-of-5 reconstruction correct${sh.hasSecret?' ¬∑ live secret split active':''}</span>`:'<span style="color:var(--red);">‚úó Shamir math error</span>',shamirOk);
    // Policy
    await new Promise(r=>setTimeout(r,80));
    const pol=PolicyEngine.get();
    _set('policy',pol.policies>0?`<span style="color:var(--mint);">‚úì ${pol.policies} policies active ¬∑ ${pol.grants} allow ¬∑ ${pol.revocations} deny/revoked</span>`:'<span style="color:var(--gold);">‚ö† No policies yet ‚Äî use Policy & Access tab</span>',pol.policies>0||null);
    // TruthRank
    await new Promise(r=>setTimeout(r,80));
    const tr=TruthRank.get();
    _set('tr',tr.dids>0?`<span style="color:var(--mint);">‚úì ${tr.dids} DIDs tracked ¬∑ ${tr.attestations} attestations ¬∑ ${tr.badges} badges issued</span>`:'<span style="color:var(--gold);">‚ö† No attestations yet ‚Äî use TruthRank tab</span>',tr.dids>0||null);
    const elapsed=Date.now()-t;
    _lastReport={bundle:'D ‚Äî Sovereign Identity & IAM',generatedAt:new Date().toISOString(),elapsed:elapsed+'ms',did:{registered:did.size,resolved:did.resolved},identityChain:{events:ic.events,auths:ic.auths},shamir:{mathVerified:shamirOk,hasSecret:ShamirIAM.get().hasSecret},policy:{total:pol.policies,grants:pol.grants,revocations:pol.revocations},truthrank:{dids:tr.dids,attestations:tr.attestations,badges:tr.badges}};
    document.getElementById('bv-summary').style.display='block';
    document.getElementById('bv-summary').innerHTML=`<div style="background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:16px;font-family:var(--mono);font-size:10px;line-height:1.8;color:var(--text2);">Bundle D Verification ¬∑ ${new Date().toISOString()}<br>Elapsed: ${elapsed}ms<br>DID Registry: ${did.size} entries<br>Identity Chain: ${ic.events} events<br>Shamir GF(256): ‚úì verified<br>Policy Engine: ${pol.policies} policies<br>TruthRank: ${tr.dids} DIDs ¬∑ ${tr.attestations} attestations</div>`;
  }
  function exportReport(){if(!_lastReport){showModal('Export','Run verification first.');return;}const blob=new Blob([JSON.stringify(_lastReport,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bundle-d-verify-'+Date.now()+'.json';a.click();}
  return{runAll,exportReport};
})();
</script>
</body>
</html>
